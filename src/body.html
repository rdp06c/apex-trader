    <div class="app-layout">
        <aside class="sidebar">
            <!-- Header / Branding -->
            <div class="sidebar-header">
                <div class="header-branding">
                    <div class="header-subtitle">Powered by ARC Investments</div>
                    <h1>APEX</h1>
                    <p class="header-tagline">Autonomous Portfolio EXpert</p>
                </div>
                <div class="header-actions">
                    <div id="cloudSyncStatus" class="sync-status" onclick="handleCloudSyncClick()">
                        <span id="syncIcon">&#9729;&#65039;</span>
                        <span id="syncText">Not synced</span>
                    </div>
                    <span class="status" id="status">&#9679; Active</span>
                </div>
            </div>

            <!-- Portfolio Hero -->
            <div class="hero">
                <div class="hero-label">Total Portfolio Value</div>
                <div class="hero-value" id="portfolioValue">$0.00</div>
            </div>

            <!-- Secondary Stats -->
            <div class="secondary-stats">
                <div class="secondary-stat">
                    <div class="stat-label">Cash Available</div>
                    <div class="stat-value" id="cashValue">$0.00</div>
                </div>
                <div class="secondary-stat">
                    <div class="stat-label">Total Invested</div>
                    <div class="stat-value" id="investedValue">$0.00</div>
                </div>
                <div class="secondary-stat">
                    <div class="stat-label">Positions</div>
                    <div class="stat-value" id="positionsCount">0</div>
                </div>
            </div>

            <!-- Holdings -->
            <div class="sidebar-holdings">
                <h2 class="chart-title">Current Holdings</h2>
                <div class="holdings-list" id="holdingsList">
                    <div class="empty-state">
                        No positions yet
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="sidebar-actions">
                <button onclick="runAIAnalysis()">Run AI Analysis</button>
                <button onclick="testDataFetch()" class="secondary">Dry Run</button>
                <button onclick="refreshPrices()" class="secondary">Refresh Prices</button>
            </div>

            <div class="ai-thinking" id="aiThinking">
                <div class="thinking-text pulse">APEX is analyzing the markets...</div>
                <div class="thinking-detail" id="thinkingDetail">Reading the charts and making moves...</div>
            </div>

            <!-- Account Controls (collapsible) -->
            <div class="controls collapsible-section" id="controlsSection">
                <div class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="controlsBody" onclick="toggleSection('controls')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSection('controls')}">
                    <h2 class="chart-title" style="margin-bottom: 0;">Account Controls & Settings</h2>
                    <span class="toggle-icon collapsed" id="controlsToggle">&#9662;</span>
                </div>
                <div class="section-body collapsed" id="controlsBody">
                    <!-- API Configuration Panel -->
                    <div class="api-config-panel">
                        <div class="api-config-header">
                            <span>API Configuration</span>
                            <button class="api-config-toggle-btn" onclick="toggleApiConfig()">
                                <span id="apiConfigToggle">Show</span>
                            </button>
                        </div>

                        <div id="apiConfigPanel">
                            <div class="api-security-notice">
                                <strong>Security:</strong> API keys are stored locally in your browser only. They are NEVER uploaded to GitHub or shared publicly.
                            </div>

                            <div class="control-group">
                                <label for="polygonKeyInput">Massive API Key</label>
                                <input type="password" id="polygonKeyInput" placeholder="Enter your Polygon API key">
                            </div>

                            <div class="control-group">
                                <label for="googleClientIdInput">Google Client ID</label>
                                <input type="password" id="googleClientIdInput" placeholder="Enter your Google Client ID">
                            </div>

                            <div class="control-group">
                                <label for="googleApiKeyInput">Google API Key</label>
                                <input type="password" id="googleApiKeyInput" placeholder="Enter your Google API Key">
                            </div>

                            <div class="control-group">
                                <label for="anthropicUrlInput">Anthropic API Worker URL</label>
                                <input type="text" id="anthropicUrlInput" placeholder="https://apex-proxy.your-username.workers.dev">
                                <div class="api-helper-text">
                                    Your Cloudflare Worker URL (see setup guide)
                                </div>
                            </div>

                            <button class="btn-save" onclick="saveApiKeys()">
                                Save Locally
                            </button>

                            <button class="btn-sync" onclick="syncKeysToGoogleDrive()">
                                Sync to Google Drive
                            </button>

                            <button class="btn-download" onclick="downloadKeysFromGoogleDrive()">
                                Download from Google Drive
                            </button>

                            <div id="apiKeySaveStatus"></div>
                        </div>

                        <div id="apiConfigStatus">
                            <div id="polygonStatus" class="api-status-line">Polygon: Not configured</div>
                            <div id="googleStatus" class="api-status-line">Google Drive: Not configured</div>
                            <div id="anthropicStatus" class="api-status-line">Anthropic: Not configured</div>
                        </div>

                        <div id="apiUsageStatus">
                            API Calls: 0 used today | Unlimited remaining
                        </div>
                    </div>

                    <div class="controls-grid">
                        <div class="control-group">
                            <label for="initialBalance">Initial Balance ($)</label>
                            <input type="number" id="initialBalance" value="10000" step="1000">
                        </div>
                        <div class="control-group">
                            <label for="weeklyFunding">Weekly Funding ($)</label>
                            <input type="number" id="weeklyFunding" value="1000" step="100">
                        </div>
                    </div>
                    <button onclick="initializeAccount()">Initialize Account</button>
                    <button onclick="addWeeklyFunding()" class="secondary">Add Weekly Funding</button>

                    <!-- Portfolio Backup & Recovery -->
                    <div class="backup-panel">
                        <div class="backup-panel-title">
                            Portfolio Backup & Recovery
                        </div>

                        <!-- Save to Drive -->
                        <div class="backup-section">
                            <div class="backup-panel-description">
                                Save your current portfolio to Google Drive as a backup.
                            </div>
                            <button class="btn-drive-save" onclick="manualSaveToDrive()">
                                Save Portfolio to Google Drive
                            </button>
                        </div>

                        <div class="backup-divider"></div>

                        <!-- Restore from local file -->
                        <div>
                            <div class="backup-panel-description">
                                Restore from a previously saved Apex_Portfolio.json file on your computer.
                            </div>
                            <input type="file" id="localPortfolioFile" accept=".json" style="display: none;" onchange="restoreFromLocalFile(this)">
                            <button class="btn-restore" onclick="document.getElementById('localPortfolioFile').click()">
                                Restore from Local File
                            </button>
                            <button class="btn-clear" onclick="clearLocalStorage()">
                                Clear Local Storage
                            </button>
                        </div>

                        <div id="recoveryStatus"></div>
                    </div>
                    <button onclick="resetAccount()" class="danger">Reset Account</button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <!-- Performance Analytics -->
            <div class="analytics-section">
                <h2 class="chart-title">Performance Analytics</h2>
                <div class="indices-grid">
                    <div class="index-card">
                        <div class="index-header">
                            <div class="index-name">Total Return</div>
                            <div class="index-symbol">ROI</div>
                        </div>
                        <div class="index-price" id="totalReturn">0.00%</div>
                        <div class="index-change" id="totalReturnDollar">$0.00</div>
                    </div>
                    <div class="index-card">
                        <div class="index-header">
                            <div class="index-name">Daily Performance</div>
                            <div class="index-symbol">TODAY</div>
                        </div>
                        <div class="index-price" id="dailyPerformance">0.00%</div>
                        <div class="index-change" id="dailyPerformanceDollar">$0.00</div>
                    </div>
                    <div class="index-card">
                        <div class="index-header">
                            <div class="index-name">Win Rate</div>
                            <div class="index-symbol">W/L</div>
                        </div>
                        <div class="index-price" id="winRate">0%</div>
                        <div class="index-change" id="winLossRatio">0W / 0L</div>
                    </div>
                    <div class="index-card">
                        <div class="index-header">
                            <div class="index-name">Alpha vs SPY</div>
                            <div class="index-symbol">&alpha;</div>
                        </div>
                        <div class="index-price" id="alphaValue">--</div>
                        <div class="index-change" id="spyReturn">--</div>
                    </div>
                    <div class="index-card expandable-card" role="button" tabindex="0" aria-label="Expand best trade details" onclick="toggleAnalyticsExpansion('bestTrade', this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleAnalyticsExpansion('bestTrade',this)}">
                        <span class="expand-icon">&#9662;</span>
                        <div class="index-header">
                            <div class="index-name">Best Trade</div>
                            <div class="index-symbol">TOP</div>
                        </div>
                        <div class="index-price" id="bestTrade">--</div>
                        <div class="index-change positive" id="bestTradeGain">+0%</div>
                    </div>
                    <div class="index-card expandable-card" role="button" tabindex="0" aria-label="Expand worst trade details" onclick="toggleAnalyticsExpansion('worstTrade', this)" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleAnalyticsExpansion('worstTrade',this)}">
                        <span class="expand-icon">&#9662;</span>
                        <div class="index-header">
                            <div class="index-name">Worst Trade</div>
                            <div class="index-symbol">BTM</div>
                        </div>
                        <div class="index-price" id="worstTrade">--</div>
                        <div class="index-change negative" id="worstTradeLoss">-0%</div>
                    </div>
                </div>
                <!-- Shared popover for analytics cards -->
                <div class="analytics-popover" id="analyticsPopover">
                    <div class="analytics-popover-content" id="analyticsPopoverContent"></div>
                </div>
                <div class="sub-stats-grid">
                    <div class="sub-stat-card">
                        <div class="sub-stat-label">Avg Hold Time</div>
                        <div class="sub-stat-value" id="avgHoldTime">--</div>
                    </div>
                    <div class="sub-stat-card">
                        <div class="sub-stat-label">Total Trades</div>
                        <div class="sub-stat-value" id="totalTrades">0</div>
                    </div>
                    <div class="sub-stat-card">
                        <div class="sub-stat-label">Drawdown</div>
                        <div class="sub-stat-value" id="drawdownValue">--</div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card card">
                    <h2 class="chart-title">Portfolio Performance</h2>
                    <canvas id="performanceChart"></canvas>
                </div>
                <div class="chart-card card">
                    <h2 class="chart-title">Sector Allocation</h2>
                    <div class="sector-chart-container">
                        <canvas id="sectorChart"></canvas>
                    </div>
                    <div id="sectorLegend" class="sector-legend"></div>
                </div>
            </div>

            <!-- Market Regime Indicator -->
            <div class="regime-banner" id="regimeBanner" style="display: none;" aria-live="polite">
                <div class="regime-banner-inner">
                    <div class="regime-label" id="regimeLabel">--</div>
                    <div class="regime-description" id="regimeDescription">Run AI Analysis to detect market regime</div>
                    <div class="regime-timestamp" id="regimeTimestamp"></div>
                    <div class="regime-vix" id="regimeVIX"></div>
                </div>
            </div>

            <!-- Holdings Detail (collapsible) -->
            <div class="card collapsible-section" id="holdingsDetailSection">
                <div class="section-header" role="button" tabindex="0" aria-expanded="true" aria-controls="holdingsDetailBody" onclick="toggleSection('holdingsDetail')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSection('holdingsDetail')}">
                    <h2 class="chart-title">Current Holdings</h2>
                    <span class="toggle-icon" id="holdingsDetailToggle">&#9662;</span>
                </div>
                <div class="section-body" id="holdingsDetailBody">
                    <div class="holdings-detail-grid" id="holdingsDetailGrid">
                        <div class="empty-state">No positions yet</div>
                    </div>
                    <!-- Shared catalyst popover -->
                    <div class="catalyst-popover" id="catalystPopover">
                        <div class="catalyst-popover-title">Catalyst</div>
                        <div class="catalyst-popover-text" id="catalystPopoverText"></div>
                    </div>
                </div>
            </div>

            <!-- Decision Reasoning (collapsible) -->
            <div class="chart-card card collapsible-section" id="decisionReasoningSection">
                <div class="section-header" role="button" tabindex="0" aria-expanded="true" aria-controls="decisionReasoningBody" onclick="toggleSection('decisionReasoning')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSection('decisionReasoning')}">
                    <h2 class="chart-title">APEX's Decision Reasoning</h2>
                    <span class="toggle-icon" id="decisionReasoningToggle">&#9662;</span>
                </div>
                <div class="section-body" id="decisionReasoningBody">
                    <div id="decisionReasoning">
                        <div class="empty-state">
                            No trades yet. Run AI Analysis to see APEX's reasoning!
                        </div>
                    </div>
                </div>
            </div>

            <!-- Candidate Scorecard (collapsible, collapsed by default) -->
            <div class="card collapsible-section" id="candidateScorecardSection">
                <div class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="candidateScorecardBody" onclick="toggleSection('candidateScorecard')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSection('candidateScorecard')}">
                    <h2 class="chart-title">Candidate Scorecard</h2>
                    <span class="toggle-icon collapsed" id="candidateScorecardToggle">&#9662;</span>
                </div>
                <div class="section-body collapsed" id="candidateScorecardBody">
                    <div id="candidateScorecardContent">
                        <div class="empty-state">Run AI Analysis to see scored candidates</div>
                    </div>
                </div>
            </div>

            <!-- Sector Rotation Heatmap (collapsible, collapsed by default) -->
            <div class="card collapsible-section" id="sectorRotationSection">
                <div class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="sectorRotationBody" onclick="toggleSection('sectorRotation')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSection('sectorRotation')}">
                    <h2 class="chart-title">Sector Rotation Heatmap</h2>
                    <span class="toggle-icon collapsed" id="sectorRotationToggle">&#9662;</span>
                </div>
                <div class="section-body collapsed" id="sectorRotationBody">
                    <div id="sectorRotationContent">
                        <div class="empty-state">Run AI Analysis to see sector rotation data</div>
                    </div>
                </div>
            </div>

            <!-- Learning Insights Section (collapsible) -->
            <div class="card collapsible-section" id="learningInsightsSection">
                <div class="section-header" role="button" tabindex="0" aria-expanded="false" aria-controls="learningInsightsBody" onclick="toggleSection('learningInsights')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSection('learningInsights')}">
                    <h2 class="chart-title">Learning Insights</h2>
                    <span class="toggle-icon collapsed" id="learningInsightsToggle">&#9662;</span>
                </div>
                <div class="section-body collapsed" id="learningInsightsBody">
                    <div class="learning-tag">Rules derived from trade history</div>
                    <div id="learningInsights">
                        <div class="empty-state">
                            No trades yet - Learning will begin after your first completed trade
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activity Feed (collapsible) -->
            <div class="activity-feed card collapsible-section" id="activityFeedSection">
                <div class="section-header" role="button" tabindex="0" aria-expanded="true" aria-controls="activityFeedBody" onclick="toggleSection('activityFeed')" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleSection('activityFeed')}">
                    <h2 class="chart-title">Recent Activity</h2>
                    <span class="toggle-icon" id="activityFeedToggle">&#9662;</span>
                </div>
                <div class="section-body" id="activityFeedBody">
                    <div id="activityFeed" aria-live="polite">
                        <div class="empty-state">
                            No activity yet
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat with APEX -->
            <div class="chat-section card">
                <h2 class="chart-title">Chat with APEX</h2>
                <div id="chatGate" class="chat-gate">
                    <div class="chat-gate-text">Chat uses API tokens per message</div>
                    <button class="chat-gate-btn" onclick="activateChat()">Start Chat Session</button>
                </div>
                <div class="chat-messages" id="chatMessages" style="display: none;">
                    <div class="agent-message">
                        <div class="message-avatar">A</div>
                        <div class="message-content">
                            <div class="message-name">APEX</div>
                            <div class="message-text">APEX online. I'm your AI trading agent â€” I make the moves and explain the thinking behind them. Ask me about your portfolio, any stock, market conditions, or trading concepts. I'll give you the real answer and teach you something along the way.</div>
                        </div>
                    </div>
                </div>
                <div class="chat-input-container" id="chatInputContainer" style="display: none;">
                    <input type="text" id="chatInput" placeholder="Ask APEX about trading decisions..." onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Result Modal -->
    <div class="modal" id="resultModal" onclick="if(event.target===this)this.classList.remove('active')">
        <div class="modal-content modal-narrow">
            <div id="resultModalBody"></div>
            <button class="result-modal-close" onclick="document.getElementById('resultModal').classList.remove('active')">Close</button>
        </div>
    </div>

